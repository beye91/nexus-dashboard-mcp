services:
  # PostgreSQL database for credentials and audit logs
  postgres:
    image: postgres:15-alpine
    container_name: nexus-mcp-postgres
    environment:
      POSTGRES_DB: nexus_mcp
      POSTGRES_USER: mcp_user
      POSTGRES_PASSWORD: changeme
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./src/config/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    ports:
      - "15432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mcp_user -d nexus_mcp"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nexus-mcp-network
    restart: unless-stopped

  # Certificate initialization service (generates self-signed certs on first startup)
  cert-init:
    image: alpine:latest
    container_name: nexus-mcp-cert-init
    command: sh /scripts/generate-certs.sh
    volumes:
      - certs:/app/certs
      - ./scripts:/scripts:ro
    environment:
      - CERT_DIR=/app/certs
      - CERT_DAYS=${CERT_DAYS:-365}
      - CERT_SERVER_IP=${CERT_SERVER_IP:-}
      - CERT_CN=${CERT_CN:-nexus-dashboard}
      - CERT_ORG=${CERT_ORG:-Nexus MCP}
    networks:
      - nexus-mcp-network

  # Nexus Dashboard MCP Server
  # Uses host networking to access external networks (e.g., Nexus Dashboard)
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nexus-mcp-server
    depends_on:
      postgres:
        condition: service_healthy
    network_mode: host
    environment:
      # Database (use localhost since we're on host network)
      DATABASE_URL: postgresql://mcp_user:changeme@localhost:15432/nexus_mcp

      # Nexus Dashboard Connection
      NEXUS_CLUSTER_URL: ${NEXUS_CLUSTER_URL:-https://192.168.70.101}
      NEXUS_USERNAME: ${NEXUS_USERNAME:-admin}
      NEXUS_PASSWORD: ${NEXUS_PASSWORD}
      NEXUS_VERIFY_SSL: ${NEXUS_VERIFY_SSL:-false}

      # Security
      EDIT_MODE_ENABLED: ${EDIT_MODE_ENABLED:-false}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-lGczu6Yzd2IrRrcJF3cOS8BsAOO6R-1761BRDusbCuM=}
      SESSION_SECRET_KEY: ${SESSION_SECRET_KEY:-change-me-in-production}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./openapi_specs:/app/openapi_specs:ro
      - ./logs:/app/logs
    stdin_open: true
    tty: true
    restart: unless-stopped
    command: >
      sh -c "
        echo 'Waiting for database to be ready...' &&
        sleep 5 &&
        echo 'Initializing database...' &&
        python scripts/init_database.py &&
        echo 'Starting MCP server...' &&
        python src/main.py
      "

  # FastAPI Web API Backend (HTTPS)
  # Uses host networking to access external networks (e.g., Nexus Dashboard)
  web-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nexus-mcp-web-api
    depends_on:
      postgres:
        condition: service_healthy
      cert-init:
        condition: service_completed_successfully
    network_mode: host
    environment:
      # Database (use localhost since we're on host network)
      DATABASE_URL: postgresql://mcp_user:changeme@localhost:15432/nexus_mcp

      # Security
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-lGczu6Yzd2IrRrcJF3cOS8BsAOO6R-1761BRDusbCuM=}

      # MCP Remote Access (optional - leave empty for open access)
      MCP_API_TOKEN: ${MCP_API_TOKEN:-}

      # SSL/TLS Configuration
      SSL_ENABLED: "true"
      SSL_CERTFILE: /app/certs/server.crt
      SSL_KEYFILE: /app/certs/server.key
      WEB_API_PORT: "8444"
      INTERNAL_HTTP_PORT: "8001"

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./openapi_specs:/app/openapi_specs:ro
      - ./logs:/app/logs
      - ./scripts:/app/scripts:ro
      - certs:/app/certs:ro
    restart: unless-stopped
    command: ["sh", "/app/scripts/start-web-api.sh"]

  # Next.js Web UI (HTTPS)
  web-ui:
    build:
      context: ./web-ui
      dockerfile: Dockerfile
    container_name: nexus-mcp-web-ui
    depends_on:
      - web-api
      - cert-init
    network_mode: host
    environment:
      # Backend API URL for server-side proxying (web-api is on host network, port 8001)
      - BACKEND_API_URL=http://localhost:8001
      # SSL/TLS Configuration
      - SSL_ENABLED=true
      - SSL_CERTFILE=/app/certs/server.crt
      - SSL_KEYFILE=/app/certs/server.key
      - PORT=7443
      # Allow self-signed certificates for internal communication
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    volumes:
      - certs:/app/certs:ro
    restart: unless-stopped

networks:
  nexus-mcp-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  certs:
    name: nexus-mcp-certs
    driver: local
